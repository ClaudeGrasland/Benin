---
title: "ECOLE D'ETE CIST 2022"
subtitle: "Inventaire préparatoire des données"
date: "`r Sys.Date()`"
author: 
 - name: Claude Grasland
   affiliation: Université de Paris (Diderot), UMR 8504 Géographie-cités, FR 2007 CIST
logo: "data/figures/HDX.png"  
output:
  rzine::readrzine:
    highlight: kate
    number_sections: true
csl: Rzine_citation.csl
bibliography: biblio.bib
nocite: |
  @*
link-citations: true
#licence: "[![licensebuttons by-sa](https://licensebuttons.net/l/by-sa/3.0/88x31.png)](https://creativecommons.org/licenses/by-sa/4.0)"
#giturl: "[![Code source on GitHub](https://badgen.net/badge/Code%20source%20on%20/GitHub/blue?icon=github)](xxx)"
#doi: "[![DOI:xxx](https://zenodo.org/badge/DOI/xxx.svg)](https://doi.org/xxx)"
---


```{r setup, include=FALSE}

library(knitr)
library(rzine)
library(sf)
library(leaflet)
library(FactoMineR)
library(mapsf)
library(data.table)
library(tidyr)
library(dplyr)
library(ggplot2)
library(cowplot)
library(mapview)
library(DT)
library(stargazer)
library(wbstats)
library(rnaturalearth)
library(rnaturalearthdata)


## Global options
options(max.print="75")
opts_chunk$set(echo=FALSE,
	             cache=FALSE,
               prompt=FALSE,
               tidy=FALSE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               class.source="bg-info",
               class.output="bg-warning")

# opts_knit$set(width=75)
```

# DONNEES INTERNATIONALES

Nous allons présenter ici deux packages R qui correspondent à des API permettant de télécharger respectivement des données statistiques de la Banque Mondiale et des fonds de carte Natural Earth. Chacune de ces API a été implémentée sous le forme de package R ce qui permet d'extraire facilement les données, dès lors qu'on dispose d'une connexion internet suffisante. Un intérêt évident de cette approche par API est de pouvoir effectuer facilement des requêtes sur n'importe quelle partie du monde et de pouvoir mettra à jour régulièrement les données au fur et à mesure de leur mise à jour. 

A titre d'exemple, nous allons montrer comment réaliser une carte des émissions de CO2 par habitant des pays de la CEDEAO en 2018. 


## L'API Banque Mondiale 

Supposons que l'on souhaite télécharger la population, le PIB et les émisssions de CO2 des pays du monde de 2000 à 2015. Plutôt que d'aller chercher des fichiers sur un site web, nous allons utiliser une API proposée par la Banque Mondiale qui permet de télécharger les données facilement et surtout de les mettre à jour régulièrement. Pour cela on va installer le package R correspondant à l'API `wbstats` de la Banque mondiale.

https://cran.r-project.org/web/packages/wbstats/vignettes/Using_the_wbstats_package.html



Au moment du chargement du package, il est créé un fichier wb_cachelist qui fournit l'ensemble des donnes disponibles sous la forme d'une liste de tableaux de méta-données.




```{r}
library("wbstats")
cat<-wb_cachelist
str(cat,max.level = 1)
```


### Le tableau "countries"

Il fournit des renseignements de base sur les différents pays, leurs codes, etc.

```{r}
str(cat$countries)
```

Le tableau comporte 304 observation et il mélange des pays (France), des fragments de pays (Réunion) et des agrégats de pays (Europe). Il faudra donc bien faire attention lors de l'extraction à réfléchir à ce que l'on souhaite utiliser. Par exemple, si l'on veut juste les pays :

```{r}
## Programme en langage R_base
# pays<-cat$countries[cat$countries$income_level!="Aggregates",c("iso3c", "country","capital_city","longitude","latitude", "region","income_level")]


## Programme en langage dplyr

pays <- cat$countries %>% 
          filter(income_level !="Aggregates") %>%
          select(iso3c,country, capital_city, latitude, longitude, region, income_level)


kable(head(pays))

```

### Le tableau indicators

Il comporte pas loin de 17000 variables ... Autant dire qu'il est difficile de l'explorer facilement si l'on ne sait pas ce que l'on cherche. 

```{r}
indic<-cat$indicators
dim(indic)
kable(head(indic))
```
#### Recherche du code d'un indicateur

Supposons qu'on recherche les données récentes sur les émissions de CO2. On va utiliser le mot-clé *CO2* pour rechercher les variables correspondantes dans le catalogue à l'aide de la fonction `wbsearch`, ce qui donne 45 réponses 

```{r}
vars <- wbsearch(pattern = "CO2",fields="indicator")
kable(head(vars))
```

On va finalement trouver le code de la variable recherchée

- *EN.ATM.CO2E.KT* : émissions de CO2 en kilotonnes

Les deux autres variables dont nous avons besoin ont pour code 

- *NY.GDP.MKTP.CD* : PIB en parités de pouvoir d'achat
- *SP.POP.TOTL* : Population totale


#### Extraction des métadonnées 

Une fois que l'on pense connaître le code de nos variables, on peut extraire les métadonnés pour vérifier qu'il s'agit bien de ce que l'on cherche, quelle est la source exacte, quelle est l'unité de mesure ...

```{r}
# Programme R-base
meta<-cat$indicators[cat$indicators$indicator_id %in% c("SP.POP.TOTL","NY.GDP.MKTP.CD","EN.ATM.CO2E.KT"),]

# Programme dplyr
meta<-cat$indicators %>%
        filter(indicator_id %in% c("SP.POP.TOTL","NY.GDP.MKTP.CD","EN.ATM.CO2E.KT"))

kable(meta)
```


### L'extraction des données

Elle se fait à l'aide de la fonction `wb_data` qui comporte de nombreuses options. 



#### le paramètre `indicator = `

Ce paramètre permet de choisir les indicateurs à collecter, ce qui suppose que l'on connaisse leur code. Par exemple, supposons que l'on veuille extraire la population et le PIB pour pouvoir calculer ensuite le PIB par habitant

```{r}
df   <- wb_data(indicator  = c("NY.GDP.MKTP.CD","SP.POP.TOTL", "EN.ATM.CO2E.KT"))
dim(df)
kable(head(df,6))

```

- **commentaire** : Nous obtenons un tableau très grand (> 13000 lignes) qui comporte les valeurs pour toutes les dates disponibles depuis 1960 et pour tous les pays, même si les valeurs sont souvent manquantes. 


### le choix d'une période de temps

#### les paramètres `startdate = ` et `startdate = ` 

Ces deux paramètres permettent de choisir une plage de temps. On peut par exemple décider de ne collecter que les données relatives aux années 2017, 2018 et 2019 

```{r}
df   <- wb_data(indicator  = c("NY.GDP.MKTP.CD","SP.POP.TOTL", "EN.ATM.CO2E.KT"),
                start_date = 2017,
                end_date = 2019)
dim(df)
kable(head(df,6))

```

- **commentaire** : Le tableau ne comporte donc plus que 651 lignes correspondant aux trois dates pour les différents pays du Monde. 


#### Le paramètre `mrv` (most recent value)

Lorsque l'on souhaite juste obtenir les données les plus récentes, on peut remplacer les paramètres `startdate = ` et `startdate = `  par le paramètre `mrv = ` suivit d'un chiffre indiquant le nombre d'années que l'on souhaite à partir de la date la plus récente. Avec mrv=1 on récupère uniquement la dernière année disponible pour au moins l'une des variables.

```{r}
df   <- wb_data(indicator  = c("NY.GDP.MKTP.CD","SP.POP.TOTL","EN.ATM.CO2E.KT"),
                mrv = 1)
dim(df)
kable(head(df,6))
```

L'inconvénient de cette méthode est que cela peut aboutir à un grand nombre de valeurs manquantes si l'une des variables recherchée n'a pas été mise à jour. 
Il est donc préférable de sélectioner une période plus longue mrv=5 et de faire ensuite soi-même le tri

### Le choix des unités géographiques



Le paramètre `country = ` permet de choisir les entités spatiales à collecter, soit sous forme de liste de codes, soit à l'aide de valeurs spéciales. Par défaut; il renvoie la liste de tous les pays, mais on peut se limiter à quelques uns seulement à l'aide de leur nom en anglais (risqué ...) ou de leur code ISO3 (plus sûr)

#### sélection de pays

```{r}
df   <- wb_data(indicator  = c("NY.GDP.MKTP.CD","SP.POP.TOTL","EN.ATM.CO2E.KT"),
                start_date = 2018,
                end_date = 2018,
                country = c("BEN","TGO"))
df$GDP.per.capita <- round(df$NY.GDP.MKTP.CD / df$SP.POP.TOTL,0)
df$CO2.per.capita <- round(1000*df$EN.ATM.CO2E.KT / df$SP.POP.TOTL,2)
kable(head(df,6))
```

- **commentaire** : Il est donc facile de travailler sur un petit nombre de pays que l'on souhaite comparer.

#### Opérateurs spéciaux

Il existe un certain nombre de paramètres spéciaux que l'on peut utiliser à la place de la liste des pays :

- "countries_only" (Default)
- "regions_only"
- "admin_regions_only"
- "income_levels_only"
- "aggregates_only"
- "all"




```{r}
df   <- wb_data(indicator  = c("NY.GDP.MKTP.CD","SP.POP.TOTL","EN.ATM.CO2E.KT"),
                start_date = 2018,
                end_date = 2018,
                country = "regions_only")
df$GDP.per.capita <- round(df$NY.GDP.MKTP.CD / df$SP.POP.TOTL,0)
df$CO2.per.capita <- round(1000*df$EN.ATM.CO2E.KT / df$SP.POP.TOTL,2)
kable(df)
```

- **commentaire** : Nous avons extrait les données par grandes régions du Monde pour l'année 2018

### Le format de sortie du tableau

Il existe deux façons d'extraire un tableau comprenant plusieurs variables ou plusieurs dates, selon que l'on veut un tableau large (wide) ou étroit. On peut régler la sortie à l'aide du paramètre `return_wide` qui est TRUE par défaut mais que l'on peut régler sur FALSE.

#### `return_wide` = FALSE

```{r}
df   <- wb_data(indicator  = c("NY.GDP.MKTP.CD","SP.POP.TOTL","EN.ATM.CO2E.KT"),
                return_wide = TRUE,
                start_date = 2017,
                end_date = 2018,
                country = c("BEN","TGO"))
df
```

#### `return_wide` = FALSE

```{r}
df   <- wb_data(indicator  = c("NY.GDP.MKTP.CD","SP.POP.TOTL","EN.ATM.CO2E.KT"),
                return_wide = FALSE,
                start_date = 2017,
                end_date = 2018,
                country = c("BEN","TGO"))
df[,1:7]
```


## L'API Natural Earth


###  Natural Earth

Nous allons ici utiliser le fonds de carte *Natural Earth* qui est un fonds de carte libre de droit et mis à jour régulièrement. Le site web du projet se situe à l'adresse suivante :

https://www.naturalearthdata.com/

Il indique ses objectifs comme suit : 

> "Natural Earth is a public domain map dataset available at 1:10m, 1:50m, and 1:110 million scales. Featuring tightly integrated vector and raster data, with Natural Earth you can make a variety of visually pleasing, well-crafted maps with cartography or GIS software.[...] Natural Earth was built through a collaboration of many volunteers and is supported by NACIS (North American Cartographic Information Society), and is free for use in any type of project (see our Terms of Use page for more information)."

On peut télécharger les différents fonds de carte sur le site web, mais dans une perspective de mise à jour automatique régulière du fonds de carte il est plus pertinent d'utiliser l'API `rnaturalearth`qui permet d'accéder directement à la plupart des fonds de carte avec juste quelques lignes de code. Il suffit pour cela de commencer par installer et charger le package.

```{r}
library("rnaturalearth")
library("rnaturalearthdata")
```



### le fonds de carte *countries110* (175 unités)

On va télécharger tout d'abord le fonds de carte des pays du Monde avec une forte généralisation des contours `countries110` et le transformer en objet de type spatial feature du package  `sf` du package avant de le visualiser et d' examiner le nombre d'unités 


```{r}
map<-st_as_sf(countries110)
class(map)

ggplot(data = map) +
        geom_sf(fill="lightyellow") +
        theme_bw()


```

Ce fonds de carte comporte 175 unités spatiales, mais de quoi s'agit-il exactement. Les métadonnées associées permettent de se faire une idée plus précise de la nature exacte de ces unités. Prenons pour cela quelques exempes

```{r}
sel<-map[map$adm0_a3 %in% c("FRA", "NCL","ATA","ATF","USA", "PRI","CHN","TWN","MAR", "SAH","CHN","TWN","ISR","PSX"),c("sovereignt","sov_a3","type","admin", "adm0_a3","name","note_adm0","iso_a3","wb_a3")]
kable(sel)
```

Les exemples présentés dans le tableau ci-dessus montrent la complexité du problème de définition et de représentation cartographique des "pays" ou "bouts du monde". Quelques remarques :

1. La *France* (FR1) en tant qu'état souverain regroupe ici cartographiquement la partie métropolitaine du pays et les Départements d'Outre-Mer (Guyane Française, Réunion, Martinique, Guadeloupe) en une seule entité spatiale, mais elle met à part la Nouvelle Calédonie et les îles antarctiques. 
2. *Porto Rico* (PRI) est considéré comme une dépendance des *Etats-Unis* (US1) au même titre que la *Nouvelle Calédonie*(NCL) est considérée comme une dépendance de la *France* (FR1).
3. Le *Sahara occidental* (SAH) est considéré comme une zone *indéterminée* bien qu'il soit occupé par le *Maroc* (MAR).
4. la Palestine (PSX) est considéré comme une zone *disputée* mais rattachée en terme de souveraineté à *Israël* (ISR) et une note précise qu'elle est *partiellement semi-administrée*. Le code sur trois caractères des territoires palestiniens est très variable selon les organisations (PSX, PSE, WBG).
5. *Taïwan* (TWN) est présenté comme un état souverain, mais son code ISO3 est manquant pour la banque mondiale car la Chine refuse de le reconnaître. 
6. Plusieurs états souverains de petite taille sont absents de ce fonds de carte qui ne regroupe que 175 unités soit moins que les 193 pays membres des Nations-Unies. La plupart des îles du Pacifique sont en particulier éliminées car leur surface les rendrait invisible pour le degré de généralisation cartographique adopté. 


###  le fonds de carte *sovereignty110* (171 unités)

On peut obtenir un fonds différent en installant le package complémentaire `rnaturalearthdata` qui permet notamment de distinguer le fonds de carte des *countries* (c'est-à-dire des "bouts du monde" souverains ou non) et des *sovereignty* (c'est-à-dire des états souverains)

```{r}
library(rnaturalearthdata)
map<-st_as_sf(sovereignty110)

ggplot(data = map) +
 geom_sf(fill="lightyellow") +  
  theme_bw()

```

Le fonds de carte permet désormais de récupérer la plupart des pays souverains du Monde, y compris les petits états insulaires du Pacifique, mais il fait disparaître de façon sélective les territoires indéterminés ou disputés. Ainsi, le Sahra Occidental demeure partiellement séparé du Maroc mais les territoires palestiniens sont annexés à Israël ainsi que le plateau du Golan ce qui n'est évidemment pas un choix neutred'un point de vue géoolitique.

```{r}
par(mfrow=c(1,2))

map2<-map %>% filter(sov_a3 %in% c("ISR","JOR","SYR","LBN","EGY"))
ggplot(data = map2) +
    geom_sf(fill=c("gray80","orange","gray80","gray80","gray80")) +
    ggtitle("Limits of Israël") +
  theme_minimal()


map3<-map %>% filter(sov_a3 %in%c("MAR","SAH","DZA","MRT"))
ggplot(data = map3) +
    geom_sf(fill=c("gray70","orange","gray70","lightyellow")) +
    ggtitle("Limits of Morocco") +
  theme_minimal()




```



### Le fonds de carte *countries50* 

On peut également choisir un fonds moins généralisé dans lequel tous les petits pays seront présents

```{r}

map<-st_as_sf(countries50)
ggplot(data = map) +
    geom_sf(fill="lightyellow") +
  theme_bw()

```

Il existe toute une série d'autres fonds de carte dans le package Natural Earth, notamment avec des résolutions plus précises, mais on se limitera ici à l'exploration des fonds de carte utile pour produire des cartes à contour généralisé couvrant le monde entier.


## Exemple d'application

Nous allons essayer de constituer une carte des émissions de CO2 par habitant des pays de la CEDEAO en 2018 basée sur la combinaison des données `wbstats` et du fonds de carte `naturalearth`.

### Etape 1 : récupération des données statistiques


Nous commençons par récupérer les données brutes de population et de CO2 en 2018 pour les pays de la CEDEAO et on y ajoute les latitues et longitues des centres des pays.

```{r}
cedeao<-c("BEN","BFA","CPV","CIV", "GMB","GIN","GNB","GHA","LBR","MLI","NER","NGA","SEN","SLE","TGO")
df   <- wb_data(indicator  = c("SP.POP.TOTL", "EN.ATM.CO2E.KT"),
                return_wide = TRUE,
                start_date = 2018,
                end_date = 2018,
                country = cedeao)
kable(df)

```

Nous renommons les variables pour avoir un tableau plus simple ou la population est en millions d'habitants, les émissions de CO2 en millions de tonnes. On y ajoute l'intensité des émissions en tonnes par habitant.



```{r}

don <-df %>% select(ISO3 = iso3c, NOM = country, POP = SP.POP.TOTL, CO2 = EN.ATM.CO2E.KT) %>%
            mutate(POP = POP/1000000, CO2 = CO2/1000, CO2_hab = CO2/POP)
kable(don,digits = 2)

```





### Etape 2 : Récupération du fonds de carte

on récupère ensuite le fonds de carte en ne gardant que les pays de la CEDEAO

```{r}
cedeao<-c("BEN","BFA","CPV","CIV", "GMB","GIN","GNB","GHA","LBR","MLI","NER","NGA","SEN","SLE","TGO")
map<-st_as_sf(countries110)
map<-st_as_sf(countries110) %>% 
        select(adm0_a3,geometry) %>% 
        rename(ISO3 = adm0_a3) %>%
        filter(ISO3 %in% cedeao)
plot(map$geometry, col="lightyellow")
```



### Etape 3 : Jointure du fonds de carte et des statistiques

```{r}
mapdon <- right_join(don,map) %>% st_as_sf()
kable(head(mapdon))
```

### Etape 4 : Visualisation avec mapsf


```{r}

mf_theme("agolalight")
mapdon %>% 
  mf_map() %>%
  mf_map("CO2_hab", 
         "choro",
         breaks="jenks",
         leg_pos="bottomleft",
         leg_title = "en tonnes/hab.")%>%
  mf_map("CO2", 
         "prop",
         col="red",
         leg_pos = "topleft",
         leg_title = "en tonnes")
mf_title("Emissions de CO2 des pays de la CEDEAO en 2018")

```









# Bibliographie {-}

<div id="refs"></div>


# Annexes {-}


## Infos session  {-}

```{r session_info, echo=FALSE}
kableExtra::kable_styling(kable(sessionRzine()[[1]], row.names = F))
kableExtra::kable_styling(kable(sessionRzine()[[2]], row.names = F))
```





## Citation {-}

```{r generateBibliography, echo=FALSE}

cat(readLines('cite.bib'), sep = '\n')

``` 

<br>

## Glossaire {- #endnotes}

```{js, echo=FALSE}

$(document).ready(function() {
  $('.footnotes ol').appendTo('#endnotes');
  $('.footnotes').remove();
});

```


